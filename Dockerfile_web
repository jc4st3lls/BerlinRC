ARG WEBPORT=443
ARG HUBPORT=80
#Warning !!! Only for test purpose
ARG CERT=LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM3RENDQWRTZ0F3SUJBZ0lRWC9tbWthVlppNGxCU2tTTXFNK1ROREFOQmdrcWhraUc5dzBCQVFzRkFEQVUKTVJJd0VBWURWUVFERXdsc2IyTmhiR2h2YzNRd0hoY05Nakl3TmpFMU1EZ3dOelEzV2hjTk1qY3dOakUxTURBdwpNREF3V2pBVU1SSXdFQVlEVlFRREV3bHNiMk5oYkdodmMzUXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCCkR3QXdnZ0VLQW9JQkFRQzF1ZWpFMDlycmRtYkFYY01YUVc0aVQxVWowOTBxSzNiVFpWcFQ0QmZZNUNpMzV3YlcKbGVLdlRYclZvaGNKQmtjSmRlVW9JeVdRUmdkUWRIaElMQnIwZXZhbTVid1QyUXVDVnZDSkpheTdPbzIrTTl3Vwp5K3dhSVVvaWNMRmlmUVp2RUtKUmZ2SkdzZnNOdmxYOUhMNnVVNitWUWhCWWQ4eXRGU2V1RUNGVS9ZdHNZci9ICmNMc3hGaU5yaUZjUDBRNGVveFRuNlFIclVtUUJESS9rQXN3bmNmVzlXdDBmYmVtNXRidVVXTm1BV3lOdzBCQWgKTTZFTmJtaFBzQ3AvbEZCY0owQVQ1Q1BhQVpnd1VoNndsQ1B6d2xYYTE1ckJGZGYzekZEeGIxZmlaSG5XWGlkawp1UTBWUkw4a1pDdUQwa08xbFFvVTM4aENvWlJZdUsxWUpPNDVBZ01CQUFHak9qQTRNQXNHQTFVZER3UUVBd0lFCnNEQVRCZ05WSFNVRUREQUtCZ2dyQmdFRkJRY0RBVEFVQmdOVkhSRUVEVEFMZ2dsc2IyTmhiR2h2YzNRd0RRWUoKS29aSWh2Y05BUUVMQlFBRGdnRUJBRWo0WDhqUnNuUytxRitkU3YyeTVhS0N3d1duZVhyOGZBU3E0VmxGTGcvWApYQmxybERQMXJLM0VzR2Y3MVk0TCtJTU92eGxEQjNmNW03akhyTE91bmdrOTB0QmJpaWt2VXNCVmZoVHNXVXRWCjc5U09pNThyK1ltUXphMHpzTjl1VG12cExrS2QvYlJoVFgwQlMxUGNubytNWVVXcitCcXJuMTFVYnZ4b2IyU1kKNXNmcWQ4WW1TMGdsVTVVdW5ML0pLbU5Rd21PcE5VQTdWemxMYXpOSmIzdGQxVThmek4wQ3ZJVHlreEtTK1p0NQpxRDgxM2pUUDg4NzllZXd4WHFtRjJ0Tll5OENEVzhja1FOYXR6QVFJZEp4amRubFRoNUhqaHhQR0Z3ejRyQkk4CjVuOU5idmdXeldIdjBkelNHRHVLaU4xZ0o2SFJMbTNRc1gvSGIzaTNWc009Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0=
ARG KEY=LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2Z0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktnd2dnU2tBZ0VBQW9JQkFRQzF1ZWpFMDlycmRtYkEKWGNNWFFXNGlUMVVqMDkwcUszYlRaVnBUNEJmWTVDaTM1d2JXbGVLdlRYclZvaGNKQmtjSmRlVW9JeVdRUmdkUQpkSGhJTEJyMGV2YW01YndUMlF1Q1Z2Q0pKYXk3T28yK005d1d5K3dhSVVvaWNMRmlmUVp2RUtKUmZ2SkdzZnNOCnZsWDlITDZ1VTYrVlFoQllkOHl0RlNldUVDRlUvWXRzWXIvSGNMc3hGaU5yaUZjUDBRNGVveFRuNlFIclVtUUIKREkva0Fzd25jZlc5V3QwZmJlbTV0YnVVV05tQVd5TncwQkFoTTZFTmJtaFBzQ3AvbEZCY0owQVQ1Q1BhQVpndwpVaDZ3bENQendsWGExNXJCRmRmM3pGRHhiMWZpWkhuV1hpZGt1UTBWUkw4a1pDdUQwa08xbFFvVTM4aENvWlJZCnVLMVlKTzQ1QWdNQkFBRUNnZ0VBQmkrdys5cFdib09XVmVBYlB4UnNJbURlL2h3OVFDMUFtMHVzK29QN2E5ZkEKaHhvblFuRFJ5YlB5aFlsQ0RYMllOM3M2OU5YVmRvYmJ3dUprSWRqV2hoSVZpWEx5cHg1UlpQdCtycnlJbDhzVApmakVYd2ZMcE02NkVibzIxakN2RFowNkNxQkdSUDlUWlBndUhzOWtocUorU3I1c1RJVi9hcU4yNmZ4TnZmd3dmCnovZlluSTZIYmhzU1Y0bWRzSWRXZmJVcitXODN6TEhGS2tqejZhNWJibkMwNURuVTFuTWpIUXR0clM4MlRnVGcKWExDd0NrZHVJTEJWM3BwOUFVNmFwZU9Yb2RnSHBoS3ZUNUF4V0JobHN5c0M3dGMvWCtsK0xUejVFTVUvS3NQTQp6SEZPUW1zeTJEV3ZOejFoSHJLWk5sV3hXMjJvWUxqRXNsR2dlY2JsdlFLQmdRREZoYW5HNXJoOUo1cXExdDJBCkFEZmlxa29tREZxRlpBNWVXYyt1dmVOb0JGaytjV3ArUm05ZmxjTy9RL1RmVVRyMHR4NEZKWC9MWGFvR3BXckwKY21qV3E5bGVGY3JDUGYxb2VKSllIWmxsdmhVZTlnbjJHY0dxQU44ZVVPaEJIT2xkUWFMRHE5ZzFmS0xIdExOYwpMUm1OSXVJRjhuQkl1cWpxSktIOFdNdVdFd0tCZ1FEcmh4QWMraEFHYlVFZzJDU3MwVW1sNGxBL3J6NEZxU3BWCnZYd3libjh4R1JrRnJTbEhFQk5iNEdsNERqSEczYUo5dUlyVW1Obi9xNVZGY2NaRzNRVmlkQWpjTkljakxPYzUKNXRvdGxXczM1Qi96R0dzcWJoWGNvOVV1Uzg4SzFoOTZwVDVaaXBVeG9DVXdJVUFXVzdBZUZRLy9FbDZKc3piUApRYlRXQTZxa0F3S0JnUUMvOGtkdFliS3c5UGFweEVuVjVPQnFKY0FPdjN5TUdoS1lmOENCK0Vmd1FpR1R1OVdZClJzeGVZQVNzYnRhYzJheG9PVGMwR3gvWU9mcExvUjVwL0pHQzQ5ZEZSZm9XenZUZVBDVkMrZWlpNVpoUzBSZ1gKRHlxVEVXdkJZekNBYmg4ZG4vWVRIb0RxWVdjeW1SaWZuN2d2M2xFMUpFY1hka1ZGM0RtS0o2UVgvd0tCZ0dReQo5SWJ2VjJ2MGhQV2RIcFVyQUdNREVkTFdFZFBFc1E4QzZ0aGxxOVRPY1plNW9FcnNLdUEyYTRnNHViSjV6Y3dnCmUyZVFrNFd5a0hHWHdwdVpJZFpOdVFzOWlaUk1ZUjUvK0tmVjNtUkx0OC9xdm9TeGlybHdOWnhaZ2Y2Qk02a3cKcllMWWN6cEdnQ3VtcWFZWllhYWFuVkNObHd5TDRyQnZxcWcxclIzVEFvR0JBSVpaQjhPQ3daeDFBejFJN3g1dApJOEJrcTZCRklIeDlmb2dzVTc1bWVwR25ZeGNYeDBtNXU2VWhUMVlxblhtL0hTcFhqUGZXSUpFUnMrRkptNjdICi9lVE5xUjlzZ0M2cEJmUlQzOW5HV1g2QXA1TFlLeHNYcTI5eTQ3NnUzRGVMNEJaNERVV0JFQkV4RzBoNXk5UlEKRlFLcDNFWWtHdGNlMVRCWTBycVF0Z21NCi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0=

FROM rust:1.89-bullseye AS builder

WORKDIR /usr/src/berlinproto
COPY berlinproto .
WORKDIR /usr/src/berlinweb
COPY berlinweb .
RUN cargo install --path .

FROM debian:bookworm-slim AS final
ARG WEBPORT
ARG HUBPORT
ARG CERT
ARG KEY
ARG UID=10001
ENV BERLINRC_WEB_PORT=${WEBPORT}
ENV BERLINRC_HUB_PORT=${HUBPORT}
#Warning !!! Only for test purpose
#BERLINRC_PASSWORD
#. Default -> 12345678 
ENV BERLINRC_PASSWORD=1Np4ssW0rd
#Warning !!! Only for test purpose
#BERLINRC_OTP_SECRET -> BASE32 String
#. Default -> Random
ENV BERLINRC_OTP_SECRET=CYDD75BIYIY6MIOUBG5ZTQMMD36WASGI
#Warning !!! Only for test purpose
#. Default -> localhost auto signed
ENV BERLINRC_CERT=${CERT}
#Warning !!! Only for test purpose
#. This part on secrets!!!! It's a example!!!
ENV BERLINRC_KEY=${KEY}
COPY --from=builder /usr/local/cargo/bin/berlinweb /usr/local/bin/berlinweb
EXPOSE ${WEBPORT}
EXPOSE ${HUBPORT}
RUN adduser \
    --disabled-password \
    --gecos "" \
    --home "/nonexistent" \
    --shell "/sbin/nologin" \
    --no-create-home \
    --uid "${UID}" \
    appuser
USER appuser
ENTRYPOINT ["berlinweb"]


